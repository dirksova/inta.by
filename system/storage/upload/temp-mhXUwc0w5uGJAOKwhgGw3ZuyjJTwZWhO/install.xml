<?xml version="1.0" encoding="UTF-8"?>
<modification>
	<id>Go Filter</id>
	<name>Go Filter module for Opencart version 2.3</name>
	<code>Go Filter module for Opencart version 2.3</code>
	<version>2.3.x</version>
	<author>Rostov85</author>
	<file path="catalog/controller/product/category.php">
		<operation error="skip">
            <search><![CDATA[$this->load->model('catalog/category');]]></search>
            <add position="after"><![CDATA[
			/* Ocmod filter */
			
				if (isset($this->request->get['gofilter'])) {
					$gofilter = $this->request->get['gofilter'];
				} else {
					$gofilter = false;
				}
				
				$data['gofilter'] = $gofilter;
				
				if (isset($this->request->get['nofilter'])) {
					$nofilter = $this->request->get['nofilter'];
				} else {
					$nofilter = false;
				}
				
				$data['nofilter'] = $nofilter;
				
				if ($nofilter or $gofilter) {
					$this->load->model('extension/module/gofilter');
					$products_array = $this->model_extension_module_gofilter->getOptionsProducts($this->request->get);
					$products = $this->model_extension_module_gofilter->getGenerationEnumeration($products_array);
				}
				
				if (strpos($this->request->server['REQUEST_URI'], "gofilter/") !== false) {
					$this->load->language('extension/module/gofilter');
				}
				
				$data['categories'] = array();

				if (isset($this->request->post['products_id'])) {
					$products = $this->request->post['products_id'];
					$data['products'] = $products;
				}
				
				if (isset($this->request->get['products_id'])) {
					$products = $this->request->get['products_id'];
					$data['products'] = $products;
				}
				
				if (isset($this->request->get['route_layout'])) {
					$route_layout = true;
				} else {
					$route_layout = false;
				}
				
				$url_filter = "";
				
				if (isset($this->request->get['gofilter']) or isset($this->request->get['nofilter'])) {
					
					if (isset($this->request->get['category_id'])) {
						$url_filter .= '&categ_id=' . $this->request->get['category_id'];
					}
					if (isset($this->request->get['categ_id'])) {
						$url_filter .= '&categ_id=' . $this->request->get['categ_id'];
					}
					if (isset($this->request->get['patfilter'])) {
						$url_filter .= '&path=' . $this->request->get['patfilter'];
					}
					if (isset($this->request->get['prices_min_value'])) {
						$url_filter .= '&prices_min_value=' . $this->request->get['prices_min_value'];
					}
					if (isset($this->request->get['prices_max_value'])) {
						$url_filter .= '&prices_max_value=' . $this->request->get['prices_max_value'];
					}
					if (isset($this->request->get['stock_status_filter'])) {
						foreach ($this->request->get['stock_status_filter'] as $key => $value)
						$url_filter .= '&stock_status_filter[' . $key . ']=' . $value;
					}
					if (isset($this->request->get['route_layout'])) {
						$url_filter .= '&route_layout=' . $this->request->get['route_layout'];
					}
					if (isset($this->request->get['nofilter'])) {
						$url_filter .= '&nofilter=' . $this->request->get['nofilter'];
					}
					if (isset($this->request->get['manufacturers_filter'])) {
						foreach ($this->request->get['manufacturers_filter'] as $key => $value)
						$url_filter .= '&manufacturers_filter[]=' . $value;
					}
					if (isset($this->request->get['option_filter'])) {
						foreach ($this->request->get['option_filter'] as $key => $value)
						$url_filter .= '&option_filter[]=' . $value;
					}
					if (isset($this->request->get['filter_filter'])) {
						foreach ($this->request->get['filter_filter'] as $key => $value)
						$url_filter .= '&filter_filter[]=' . $value;
					}
					if (isset($this->request->get['attributes_filter'])) {
						foreach ($this->request->get['attributes_filter'] as $key => $value) {
							if ($value) {
								foreach ($value as $key_2 => $value_2) {
									$url_filter .= '&attributes_filter[' . $key . '][]=' . $value_2;
								}
							}
						}
					}
					if (isset($this->request->get['rating_filter'])) {
						foreach ($this->request->get['rating_filter'] as $key => $value)
						$url_filter .= '&rating_filter[]=' . $value;
					}
					if (isset($this->request->get['gofilter'])) {
						$url_filter .= '&nofilter=' . $this->request->get['gofilter'];
					}
				}
				
				if (isset($this->request->post)) {
					
					if (isset($this->request->post['category_id'])) {
						$url_filter .= '&categ_id=' . $this->request->post['category_id'];
					}
					if (isset($this->request->post['categ_id'])) {
						$url_filter .= '&categ_id=' . $this->request->post['categ_id'];
					}
					if (isset($this->request->post['patfilter'])) {
						$url_filter .= '&path=' . $this->request->post['patfilter'];
					}
					if (isset($this->request->post['prices_min_value'])) {
						$url_filter .= '&prices_min_value=' . $this->request->post['prices_min_value'];
					}
					if (isset($this->request->post['prices_max_value'])) {
						$url_filter .= '&prices_max_value=' . $this->request->post['prices_max_value'];
					}
					if (isset($this->request->post['stock_status_filter'])) {
						foreach ($this->request->post['stock_status_filter'] as $key => $value)
						$url_filter .= '&stock_status_filter[' . $key . ']=' . $value;
					}
					if (isset($this->request->post['route_layout'])) {
						$url_filter .= '&route_layout=' . $this->request->post['route_layout'];
					}
					
					if (isset($this->request->post['manufacturers_filter'])) {
						foreach ($this->request->post['manufacturers_filter'] as $key => $value)
						$url_filter .= '&manufacturers_filter[]=' . $value;
					}
					if (isset($this->request->post['option_filter'])) {
						foreach ($this->request->post['option_filter'] as $key => $value)
						$url_filter .= '&option_filter[]=' . $value;
					}
					if (isset($this->request->post['filter_filter'])) {
						foreach ($this->request->post['filter_filter'] as $key => $value)
						$url_filter .= '&filter_filter[]=' . $value;
					}
					if (isset($this->request->post['attributes_filter'])) {
						foreach ($this->request->post['attributes_filter'] as $key => $value) {
							if ($value) {
								foreach ($value as $key_2 => $value_2) {
									$url_filter .= '&attributes_filter[' . $key . '][]=' . $value_2;
								}
							}
						}
					}
					if (isset($this->request->post['rating_filter'])) {
						foreach ($this->request->post['rating_filter'] as $key => $value)
						$url_filter .= '&rating_filter[]=' . $value;
					}
				}
				
				$data['url_filter'] = $url_filter;
			
			/* Ocmod filter */
            ]]></add>
        </operation>
		<operation error="skip">
            <search><![CDATA[$url = '';]]></search>
            <add position="after"><![CDATA[
			/* Ocmod filter */
				$url .= $url_filter;
			/* Ocmod filter */
            ]]></add>
        </operation>
		<operation error="skip">
            <search><![CDATA[$category_info = $this->model_catalog_category->getCategory($category_id);]]></search>
            <add position="before"><![CDATA[
			/* Ocmod filter */
				if (!isset($products)) {
				$data['compare'] = $this->url->link('product/compare');
				
			/* Ocmod filter */
				
            ]]></add>
        </operation>
		<operation error="skip">
            <search><![CDATA[$category_info = $this->model_catalog_category->getCategory($category_id);]]></search>
            <add position="after"><![CDATA[
			/* Ocmod filter */
				} else {
					$category_info = true;
					$data['heading_title'] = "";
					$data['thumb'] = false;
					$data['description'] = false;
				}
			/* Ocmod filter */
            ]]></add>
        </operation>
		<operation error="skip">
            <search><![CDATA[$data['products'] = array();]]></search>
            <add position="after"><![CDATA[
			/* Ocmod filter */ 
				if (isset($products)) {
					$data['categories'] = false;
				}
				if (!isset($products)) {
			/* Ocmod filter */
            ]]></add>
        </operation>
		<operation error="skip">
            <search><![CDATA[$product_total = $this->model_catalog_product->getTotalProducts($filter_data);]]></search>
            <add position="before"><![CDATA[
			/* Ocmod filter */ } else {

			if (isset($products)) {
				if ($products != "") {
					$products_id = $products;
				} else {
					$products_id = false;
				}
			} else {
				$products_id = false;
			}
			
			$filter_data = array(
				'filter_filter'      => $filter,
				'products_id'        => $products_id,
				'route_layout'       => $route_layout,
				'sort'               => $sort,
				'order'              => $order,
				'start'              => ($page - 1) * $limit,
				'limit'              => $limit
			);
			
			$url = '';
			
			/* Ocmod filter */ } /* Ocmod filter */
            ]]></add>
        </operation>
		<operation error="skip">
            <search><![CDATA[$data['column_left'] = $this->load->controller('common/column_left');]]></search>
            <add position="before"><![CDATA[
			/* Ocmod filter */ 
			
			if ($gofilter or $nofilter) {
				$go_filter_pagination = new Gofilterpagination();
				$go_filter_pagination->total = $product_total;
				$go_filter_pagination->page = $page;
				$go_filter_pagination->limit = $limit;
				$go_filter_pagination->url = $url . '&page={page}';
				$go_filter_pagination->products = $products;
				
				$data['go_filter_pagination'] = $go_filter_pagination->render();
			}

			$data['gofilter_cloud'] = "";
			if (!isset($products)) {

			/* Ocmod filter */
            ]]></add>
        </operation>
		<operation error="skip">
            <search><![CDATA[$data['header'] = $this->load->controller('common/header');]]></search>
            <add position="after"><![CDATA[
			/* Ocmod filter */ } else {$data['column_left'] = ""; $data['column_right'] = ""; $data['content_top'] = ""; $data['content_bottom'] = ""; $data['footer'] = ""; $data['header'] = ""; $data['gofilter_cloud'] = $this->load->controller('product/gofilterscripts');} /* Ocmod filter */
            ]]></add>
        </operation>
		<operation error="skip">
            <search><![CDATA[$this->response->addHeader($this->request->server['SERVER_PROTOCOL'] . ' 404 Not Found');]]></search>
            <add position="replace"><![CDATA[
			/* Ocmod filter */ if ($gofilter or $nofilter or strpos($this->request->server['REQUEST_URI'], "gofilter/") !== false) {} else {$this->response->addHeader($this->request->server['SERVER_PROTOCOL'] . ' 404 Not Found');} /* Ocmod filter */
            ]]></add>
        </operation>
    </file>
	<file path="catalog/model/catalog/product.php">
		<operation error="skip">
            <search><![CDATA[if (!empty($data['filter_manufacturer_id'])) {]]></search>
            <add position="before"><![CDATA[
			/* Ocmod filter */
				if (isset($data['route_layout'])) {
					if (!empty($data['products_id'])) {$sql .= " AND p.product_id IN (" . $data['products_id'] . ")";} else {$sql .= " AND p.product_id = '0'";}
				}
			/* Ocmod filter */
            ]]></add>
        </operation>
	</file>
	<file path="catalog/view/theme/*/template/product/category.tpl">
		<operation error="skip">
            <search><![CDATA[location = this.value;]]></search>
            <add position="replace"><![CDATA[<?php if ($gofilter or $nofilter) { ?>ajax_page_category_select(this.value);<?php } else { ?>location = this.value;<?php } ?>]]></add>
        </operation>
    </file>
	<file path="catalog/view/theme/*/template/product/category.tpl">
		<operation error="skip">
            <search><![CDATA[href="<?php echo $sorts['href']; ?>"]]></search>
            <add position="replace"><![CDATA[<?php if ($gofilter or $nofilter) { ?>onClick="ajax_page_category_select('<?php echo $sorts['href']; ?>');"<?php } else { ?>href="<?php echo $sorts['href']; ?>"<?php } ?>]]></add>
        </operation>
    </file>
	<file path="catalog/view/theme/*/template/product/category.tpl">
		<operation error="skip">
            <search><![CDATA[href="<?php echo $limits['href']; ?>"]]></search>
            <add position="replace"><![CDATA[<?php if ($gofilter or $nofilter) { ?>onClick="ajax_page_category_select('<?php echo $limits['href']; ?>');"<?php } else { ?>href="<?php echo $limits['href']; ?>"<?php } ?>]]></add>
        </operation>
    </file>
	<file path="catalog/view/theme/*/template/product/category.tpl">
        <operation error="skip">
            <search><![CDATA[<?php echo $content_bottom; ?>]]></search>
            <add position="before"><![CDATA[<?php echo $gofilter_cloud; ?>]]></add>
        </operation>
		<operation error="skip">
            <search><![CDATA[<?php echo $pagination; ?>]]></search>
            <add position="replace"><![CDATA[<?php if ($gofilter or $nofilter) {echo $go_filter_pagination;} else {echo $pagination;} ?>]]></add>
        </operation>
    </file>
	<file path="catalog/controller/error/not_found.php">
		<operation error="skip">
            <search><![CDATA[$this->response->setOutput($this->load->view('error/not_found', $data));]]></search>
            <add position="replace"><![CDATA[
			/* Ocmod filter */
			if (strpos($this->request->server['REQUEST_URI'], "gofilter/") !== false) {
				$massivs = explode('/', (string)$this->request->server['REQUEST_URI']);
				foreach ($massivs as $key => $value) {
					if ($value == "gofilter") {
						$key_route = $key + 1;
					}
				}
				if (isset($key_route)) {
					$massivs_route = explode('-', $massivs[$key_route]);
					$text_route = $massivs_route[0] . "/" . $massivs_route[1];
				}
				$filter_array = array();
				$seo_separator = "=";
				$this->load->model('extension/module/gofilter');
                $seo_separator = $this->model_extension_module_gofilter->getGenerationSeparator();
				foreach ($massivs as $key => $value) {
					if ($key >= $key_route) {
						$massiv = explode($seo_separator, $value);
						$key_shift = array_shift($massiv);
						$id = 0; foreach ($massiv as $value_2) {
							$filter_array[$key_shift][] = $value_2;
						}
					}
				}
				if($filter_array) {
					$data['seo_results'] = $this->model_extension_module_gofilter->getSeoElements($filter_array);
				} else {
					$data['seo_results'] = false;
				}
				$this->request->get['route'] = $text_route;
				
				if (isset($data['seo_results']['category_id'])) {$this->request->get['path'] = $data['seo_results']['category_id'];}
				$this->load->controller($text_route);
			} else {
				$this->response->setOutput($this->load->view('error/not_found', $data));
			}
			/* Ocmod filter */
            ]]></add>
        </operation>
		<operation error="skip">
            <search><![CDATA[$this->response->addHeader($this->request->server['SERVER_PROTOCOL'] . ' 404 Not Found');]]></search>
            <add position="replace"><![CDATA[
			/* Ocmod filter */
			if (strpos($this->request->server['REQUEST_URI'], "gofilter/") === false) {$this->response->addHeader($this->request->server['SERVER_PROTOCOL'] . ' 404 Not Found');}
			/* Ocmod filter */
            ]]></add>
        </operation>
	</file>
</modification>